<?xml version="1.0" encoding="utf-8" ?>
<!--
***********************************************************************************************
SlowCheetah.App.targets
Logic for App Project transformations
Copyright (C) Microsoft Corporation. All rights reserved.
Copyright (C) Sayed Ibrahim Hashimi, Chuck England 2011-2013. All rights reserved.
***********************************************************************************************
-->
<Project xmlns="http://schemas.microsoft.com/developer/msbuild/2003">

  <PropertyGroup>
    <!-- If the project is not web, it is an app-type project -->
    <WapProjectTypeGuid>349c5851-65df-11da-9384-00065b846f21</WapProjectTypeGuid>
    <ScIsApp Condition="'$(ScIsApp)' == '' and '$(ScIsWap)' == true">false</ScIsApp>
    <ScIsApp Condition="'$(ScIsApp)' == ''">true</ScIsApp>

    <!-- The path for the intermediate app.config file generated by SlowCheetah -->
    <ScIntermediateAppConfig Condition="'$(ScIntermediateAppConfig)' == ''">$(IntermediateOutputPath)$(MSBuildProjectFile)-sc.App.config</ScIntermediateAppConfig>

    <!-- Name of the application configuration file -->
    <ScAppConfigName Condition="'$(ScAppConfigName)' == ''">app.config</ScAppConfigName>
  </PropertyGroup>

  <Target Name="ScCollectAppFiles" DependsOnTargets="ScCollectTransformFiles" BeforeTargets="ScApplyTransforms">

    <Message Text="SlowCheetah: Collecting App files" Importance="low"/>

    <PropertyGroup>
      <_AppConfigFullPath>@(AppConfigWithTargetPath->'%(RootDir)%(Directory)%(Filename)%(Extension)')</_AppConfigFullPath>
    </PropertyGroup>

    <ItemGroup>
      <!-- Remove app.config transforms and execute them separately -->
      <ScAppConfigToTransform Include="@(ScFilesToTransform)" Condition="'%(Filename)%(Extension)'=='$(ScAppConfigName)'"/>
      <ScFilesToTransform Remove="@(ScFilesToTransform)" Condition="'%(Filename)%(Extension)'=='$(ScAppConfigName)'"/>
    </ItemGroup>

    <PropertyGroup>
      <!-- Determine if an app.config file has a transform -->
      <_ScHasAppConfigTransform>false</_ScHasAppConfigTransform>
      <!-- If there is a transform for the current build configuration -->
      <_ScHasAppConfigConfigurationTransform Condition="Exists('@(ScAppConfigToTransform->'%(RelativeDir)%(Filename).$(Configuration)%(Extension)')')">true</_ScHasAppConfigConfigurationTransform>
      <!-- There is a transform for the current publish profile -->
      <_ScHasAppConfigPublishProfileTransform Condition=" Exists('@(ScAppConfigToTransform->'%(RelativeDir)%(Filename).$(PublishProfile)%(Extension)')') ">true</_ScHasAppConfigPublishProfileTransform>
      <!-- If the configuration and the publish profile are the same, only one transformation is needed -->
      <_ScHasAppConfigPublishProfileTransform Condition=" '$(Configuration)'=='$(PublishProfile)' ">false</_ScHasAppConfigPublishProfileTransform>
      <!-- If the file has either of the transformations -->
      <_ScHasAppConfigTransform Condition=" '$(_ScHasAppConfigConfigurationTransform)'=='true' ">true</_ScHasAppConfigTransform>
      <_ScHasAppConfigTransform Condition=" '$(_ScHasAppConfigPublishProfileTransform)'=='true' ">true</_ScHasAppConfigTransform>
    </PropertyGroup>

    <!-- The file may be transformed multiple times, so copy it to intermediate path and transform from there -->
    <Copy SourceFiles="$(AppConfig)" DestinationFiles="$(ScIntermediateAppConfig)"/>

  </Target>

  <Target Name="ScTransformAppConfig" DependsOnTargets="ScCollectAppFiles" BeforeTargets="_CopyAppConfigFile">

    <Message Text="Applying app transformations: $(_ScHasAppConfigTransform)" Importance="low"/>

    <!-- Specific transformations for the app.config file -->
    <SlowCheetah.TransformTask Source="$(ScIntermediateAppConfig)"
                  Transform="@(ScAppConfigToTransform->'%(RelativeDir)%(Filename).$(Configuration)%(Extension)')"
                  Destination="$(ScIntermediateAppConfig)"
                  Condition="'$(_ScHasAppConfigConfigurationTransform)' == 'true'"/>
    <SlowCheetah.TransformTask Source="$(ScIntermediateAppConfig)"
                    Transform="@(ScAppConfigToTransform->'%(RelativeDir)%(Filename).$(PublishProfile)%(Extension)')"
                    Destination="$(ScIntermediateAppConfig)"
                    Condition="'$(_ScHasAppConfigPublishProfileTransform)'=='true'"/>

    <!-- Rewrite App.config build variables so the copy target gets it from new location -->
    <PropertyGroup Condition="'$(_ScHasAppConfigTransform)' == 'true'">
      <AppConfig>$(ScIntermediateAppConfig)</AppConfig>
    </PropertyGroup>

    <ItemGroup Condition="'$(_ScHasAppConfigTransform)' == 'true'">
      <AppConfigWithTargetPath Remove="@(AppConfigWithTargetPath)" />
      <AppConfigWithTargetPath Include="$(AppConfig)">
        <TargetPath>$(TargetFileName).config</TargetPath>
      </AppConfigWithTargetPath>
    </ItemGroup>

  </Target>

</Project>
